<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <!-- (1) Optimize for mobile versions: http://goo.gl/EOpFl -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- (1) force latest IE rendering engine: bit.ly/1c8EiC9 -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Phil Sturgeon</title>
  <meta name="description" content="I used to contribute to the PHP-FIG, The League of Extraordinary Packages, PHP The Right Way, CodeIgniter, FuelPHP, PyroCMS and a bunch of other stuff, but I gave it all up to join the circus" />

  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link rel="stylesheet" href="//brick.a.ssl.fastly.net/Linux+Libertine:400,400i,700,700i/Open+Sans:400,400i,700,700i">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

  <link href="/stylesheets/main.css" rel="stylesheet" media="screen" />
  <link href="/stylesheets/print.css" rel="stylesheet" media="print" />
  <link href="/images/favicon.png" rel="icon" type="image/png" />

  <meta property="og:type" content="article" />
  <meta property="article:author" content="Phil Sturgeon" />
  <meta property="og:description" content="I’ve been working at Ride.com since October 2014, and I’ve got to do some awesome stuff with them. As far as my job has been concerned, the first 4-5 months were entirely green field development. As a team we built multiple services to compliment a central API, and with the help of some other gophers at the company I built most of a little Go service to handle various autocomplete requirements." />
  <meta property="og:site_name" content="Phil Sturgeon" />
  <meta property="og:image" content="https://philsturgeon.uk/images/author.jpg" />
  <meta property="og:url" content="https://philsturgeon.uk/2015/07/26/autocomplete-google-maps-api/" />
  <meta property="og:locale" content="en_GB" />
  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@philsturgeon">
  <meta name="twitter:title" content="Phil Sturgeon">
  <meta name="twitter:image:src" content="https://philsturgeon.uk/images/author.jpg">
  <meta name="twitter:url" content="https://philsturgeon.uk/2015/07/26/autocomplete-google-maps-api/">
  <meta name="twitter:description" content="I’ve been working at Ride.com since October 2014, and I’ve got to do some awesome stuff with them. As far as my job has been concerned, the first 4-5 months were entirely green field development. As a team we built multiple services to compliment a central API, and with the help of some other gophers at the company I built most of a little Go service to handle various autocomplete requirements.">
  <meta name="twitter:creator" content="@philsturgeon">
  
  <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
</head>


  <body>

    <a class='fa fa-home logo-readium' href='/'></a>


    <!-- content start -->

    <main class="content" role="main">
      <article class="post">
        <div class="noarticleimage">
          <div class="post-meta">
            <h1 class="post-title"></h1>
            <div class="cf post-meta-text">
              <div class="author-image" style="background-image: url(/images/author.jpg)">Blog Logo</div>
              <h4 class="author-name" itemprop="author" itemscope itemtype="http://schema.org/Person">Phil Sturgeon</h4>
              on
              <time datetime="2015-07-26 00:00:00 UTC">
                Jul 26 2015
              </time>
            </div>
          </div>
        </div>
        <br>
        <br>
        <br>
        <section class="post-content">
          <div class="post-reading">
            <span class="post-reading-time"></span> read
          </div>
          <a name="topofpage"></a>
          <p>I’ve been working at <a href="https://ride.com/">Ride.com</a> since October 2014, and I’ve got to do some awesome stuff with them. As far as my job has been concerned, the first 4-5 months were entirely green field development. As a team we built multiple services to compliment a central API, and with the help of some other gophers at the company I built most of a little Go service to handle various autocomplete requirements.</p>

<p>One of the autocomplete endpoints was for addresses, allowing us to switch map API providers without totally breaking our iOS and web apps.</p>

<p>I had a few clashes with the Google Maps API along the way. Some were my fault, some were their fault, and some I just blame on imperfections in U.S. address system. To be fair, the U.K. is not much better, but the U.S had a more recent opportunity to get things a bit better and they still fucked it.</p>

<h2 id="address-autocomplete-requirements">Address Autocomplete Requirements</h2>

<ul>
  <li>Users sign up via web/iOS clients, enter their home address and enter their work address.</li>
  <li>These clients call the autocomplete service with the user input.</li>
  <li>See what Google Maps thinks of the input.</li>
  <li>Spit out some formatted JSON for the clients to display for the user to pick.</li>
</ul>

<p>I pretty much want to get this for homes and places of work:</p>

<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"addresses"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
    </span><span class="nt">"formatted_address"</span><span class="p">:</span><span class="w"> </span><span class="s2">"568 Broadway, New York, NY 10012, USA"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"street_address_1"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Broadway"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"street_address_2"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
    </span><span class="nt">"street_number"</span><span class="p">:</span><span class="w"> </span><span class="s2">"568"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"neighborhood"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Lower Manhattan"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"locality"</span><span class="p">:</span><span class="w"> </span><span class="s2">"New York"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"sublocality_level_1"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Manhattan"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"sublocality_level_2"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
    </span><span class="nt">"sublocality_level_3"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
    </span><span class="nt">"administrative_area_level_1"</span><span class="p">:</span><span class="w"> </span><span class="s2">"New York"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"administrative_area_level_1_short"</span><span class="p">:</span><span class="w"> </span><span class="s2">"NY"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"administrative_area_level_2"</span><span class="p">:</span><span class="w"> </span><span class="s2">"New York County"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"administrative_area_level_3"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
    </span><span class="nt">"country"</span><span class="p">:</span><span class="w"> </span><span class="s2">"United States"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"postal_code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"10012"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"lat"</span><span class="p">:</span><span class="w"> </span><span class="mf">40.7242802</span><span class="p">,</span><span class="w">
    </span><span class="nt">"lng"</span><span class="p">:</span><span class="w"> </span><span class="mf">-73.9973541</span><span class="p">,</span><span class="w">
    </span><span class="nt">"google_places_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="w">
  </span><span class="p">}]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>Simple enough right?</p>

<p>Heh.</p>

<h2 id="location-biasing">Location Biasing</h2>

<p>A feature the web/iOS clients and business all requested rather early on was location-based biasing. This is the art of assuming that things near you are more relevant than things far away, which is pretty fair. Somebody in Florida probably doesn’t drive to work in Texas, and definitely doesn’t need to see shit in Alaska.</p>

<p>If we were using the Google Places API then we’d be golden because you can just give them a <code>?near=lat,lng</code> and they’ll work it out for you. Sadly, the Google Places API is not useful for us. Many work places outside of major companies are not on the places API, and obviously not many people have their homes in that API either.</p>

<p>We had to stick with the Google Maps API and that does not have the same functionality. Balls. Time for a dumb hack:</p>

<pre class="highlight plaintext"><code>func vertexToBoundingBox(vertex Vertex) string {
  if vertex == (Vertex{}) {
    return ""
  }
  return fmt.Sprintf(
    "%f,%f|%f,%f",
    vertex.Lat-0.5,
    vertex.Lng-1,
    vertex.Lat+0.5,
    vertex.Lng+1,
  )
}
</code></pre>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>This has worked well enough that most people seem happy with it. It makes a rather wide box which is big enough to contain a large US city and some surrounding suburbs.</p>

<p>If the coordinates Google has for the address are considered to be a hair over the line of that bounding box then the address might as well be a on the other side of the country for all it cares.</p>

<p>Not ideal.</p>

<h2 id="one-bowerman-drive">1 One Bowerman Drive</h2>

<p>When doing research on some big corporate buildings we’d likely have people wanting to drive to, some folks at Ride spotted a problem.</p>

<p><img alt="Nike HQ and their vanity road &quot;One Bowerman Drive&quot;" src="/assets/article_images/2015-07-26-autocomplete-google-maps-api/1-one-bowerman-drive.png" /></p>

<p>Nike HQ have a vanity road called <code>One Bowerman Drive</code>, which in and of itself would not be a problem other than one thing: they advertise <code>One Bowerman Drive</code> as their address on all their media, not their real address of <code>1 One Bowerman Drive</code>.</p>

<p>The autocomplete was taking their search results, Google was returning a road, the autocomplete was throwing it away. That’s how I programmed it, to throw away anything Google offers me which is not a <code>street_address</code>.</p>

<p>Think about it, having a road instead of an actual address could be madness for calculating how far people need to drive, and would throw off our pricing calculations.</p>

<p>To offer an extreme example, if you as a driver enter “Route 66” as a destination, if you stop short of wherever Google places the pin then you are going to be drastically overcharging any passengers, and the opposite problem occurs if you drive past the pin: you’ll be losing money. Our petrol costs based on milage would be screwed, even if only by a fraction in real-world usage.</p>

<p>As with many things in programming, we are faced with various shit options. I presenting the shit options to business:</p>

<ul>
  <li>Allow roads to be used as a destination address and let people potentially be miles off of their actual destination.</li>
  <li>Do not support Nike HQ and any similar building which advertises their vanity road as an address.</li>
</ul>

<p>Yaaaaaay.</p>

<h2 id="bank-of-america-plaza">Bank of America Plaza</h2>

<p>Google returns components with a <code>types</code> array, which can have a plethora of values.</p>

<p>For a while I didn’t actually know about this type array, and was foolishly throwing away results that did not have a street_address or a route. This kicked me in the face when we realised that the Bank of America Plaza in Atlanta does not actually have a street address or route <em>at all</em>.</p>

<p><img alt="Bank of America Plaza Atlanta, one a nameless vanity road" src="/assets/article_images/2015-07-26-autocomplete-google-maps-api/no-road.png" /></p>

<p>Looking at the building on the map you can see it has a road, but that little road has no name. It is not considered to be on Peachtree St NE, nor is it on U.S. Highway 78, it is just on bloody nothing.</p>

<p>If I were to remove the check that said “no street address or route = invalid address”, the code would not only allow Bank of America Plaza Atlanta, but it would also let any town or city into the results, meaning you could easily say your pickup or destination address was <code>West Chester, NY</code>, leaving the driver to do laps around a town of a few thousand trying to find you…</p>

<p>Google has us covered here. Allow any of the following component types:</p>

<ul>
  <li><code>route</code></li>
  <li><code>street_address</code></li>
  <li><code>premise</code></li>
</ul>

<p>If you can think of any more then please send answers on the back of a postcard.</p>

<h2 id="one-bowerman-drive-again">1 One Bowerman Drive Again</h2>

<p>This bloody road.</p>

<p>At Ride we not only allow people to carpool to the same building, but we have a bit of wiggle room in there. Theoretically, if you work right next to somebody, in the same building, the next building, or the same business park, then carpooling should be an option for you.</p>

<p><em>Some companies are against that for security reasons, but we have a switch to turn it on or off for various companies.</em></p>

<p>Anyway, we allow a radius of 50 meters for now, and yes, looking at the image below that is a “square radius”. Shut up, I didn’t want to get PostGIS involved and slow down this query for a temporary feature as the geo search is being moved out of the API anyway.</p>

<p>See if you can spot what is happening in this image.</p>

<p><img alt="Nike HQs actual address vrs. their advertised address" src="/images/article_images/2015-07-26-autocomplete-google-maps-api/51-meter-difference.png" /></p>

<p>Yup, you guessed it. 1 One Bowerman Drive is 50.5 meters away from the seemingly arbitrary point on the map that Google decides to put the pin for the road One Bowerman Drive.</p>

<p>I can’t remember exactly what happened, but I have a sneaking suspicion we bumped our “square-radius” to 52 meters and called it a day.</p>

<p>You couldn’t write this stuff.</p>

          
        </section>
        <footer class="post-footer">
            <section class="share">
                  <a class="icon-twitter" href="https://twitter.com/share?text=&amp;url=https://philsturgeon.uk/2015/07/26/autocomplete-google-maps-api/"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=255');return false;">
                  <i class="fa fa-twitter"></i><span class="hidden">twitter</span>
                  </a>
                  <a class="icon-facebook" href="https://www.facebook.com/sharer.php?t=&amp;u=https://philsturgeon.uk/2015/07/26/autocomplete-google-maps-api/"
                    onclick="window.open(this.href, 'facebook-share', 'width=550,height=255');return false;">
                  <i class="fa fa-facebook"></i><span class="hidden">facebook</span>
                  </a>
            </section>
            <section class="post-next-previous">
                <p>
                    Previous:
                    <a class="button" href="/politics/2015/07/04/twatty-fallacies-fox-charleston-shooting/">Twatty Fallacies when Fox and Friends talk Flags</a>
                </p>
                <p style="float:right">
                    Next: 
                    <a class="button" href="/charity/2015/08/11/geeks-giving-for-aids-again/">Geeks Giving for Aids: 2015</a>
                </p>
            </section>
        </footer>
        <div class="bottom-teaser cf">
          <div class="more isLeft">
            <h5 class="index-headline featured"><span>Written by</span></h5>
            <section class="author">
              <div class="author-image" style="background-image: url(/images/author.jpg)">Blog Logo</div>
              <h4>Phil Sturgeon</h4>
              <p class="bio">I spend a lot of time urging people to learn more languages, and if that is a bit much learn another framework. Rails and Laravel are the same, and Go is a barrel of laughs.</p>
              <p>Get out of your rut.</p>
            </section>
          </div>
          <div class="more isRight">
            <h5 class="index-headline featured"><span>More Writing</span></h5>
            <section class="author">
              <a href="http://apisyouwonthate.com/">
                <div class="book-image build-apis">Book Cover</div>
                <h4>Build APIs You Won't Hate</h4>
              </a>
              <p class="bio">Everyone and their dog wants an API, so you should probably learn how to build them.</p>
              <p><a href="http://apisyouwonthate.com/">Buy it from LeanPub or Amazon</a>.</p>
            </section>
          </div>
        </div>
      </article>


    </main>
    <div class="bottom-closer">
      <div class="background-closer-image" style="background-image: url(/images/ciderphpants.jpg)">
        Image
      </div>
      <div class="inner">
        <h1 class="blog-title">Phil Sturgeon</h1>
        <h2 class="blog-description">I used to contribute to the PHP-FIG, The League of Extraordinary Packages, PHP The Right Way, CodeIgniter, FuelPHP, PyroCMS and a bunch of other stuff, but I gave it all up to join the circus</h2>
        <a href="/" class="btn">Back to Overview</a>
      </div>
    </div>

    <!-- content end -->

    <footer class='footer' role='contentinfo'>
  <div class='footer-links'>
    <ul class='context'>
      <li>
        <h3>Content</h3>
      </li>
      <li>
        <a href='/about'>About</a>
      </li>
      <li>
        <a href='/books'>Books</a>
      </li>
    </ul>
    <ul class='follow'>
      <li>
        <h3>Follow Me</h3>
      </li>
      <li>
        <a href='https://twitter.com/philsturgeon'>Twitter</a>
      </li>
      <li>
        <a href='https://github.com/'>GitHub</a>
      </li>
      <li>
        <a href='http://phptownhall.com/'>PHP Town Hall</a>
      </li>
    </ul>
    <ul class='recent_posts'>
      <li>
        <h3>Recent Posts</h3>
        <ul>
          <li><a href="/2015/11/24/http-rest-api-file-uploads/">HTTP/REST API File Uploads</a></li>
          <li><a href="/2015/11/20/deploying-with-git-flow-tags-and-circleci/">Deploying with Git-Flow, Tags and CircleCI</a></li>
          <li><a href="/api/2015/10/08/http-documentation-with-api-blueprint/">HTTP Documentation with API Blueprint</a></li>
        </ul>
      </li>
    </ul>
  </div>
</footer>

    <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
<script src="/javascripts/jquery.fitvids.js"></script>
<script src="/javascripts/index.js"></script>
<script src="/javascripts/readingTime.min.js"></script>
<script>
(function ($) {
  "use strict";
  $(document).ready(function(){

    var $window = $(window),
    $image = $('.post-image-image, .teaserimage-image');
    $window.on('scroll', function() {
      var top = $window.scrollTop();

      if (top < 0 || top > 1500) { return; }
      $image
        .css('transform', 'translate3d(0px, '+top/3+'px, 0px)')
        .css('opacity', 1-Math.max(top/700, 0));
    });
    $window.trigger('scroll');

    var height = $('.article-image').height();
    $('.post-content').css('padding-top', height + 'px');

    $('a[href*=#]:not([href=#])').click(function() {
      if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'')
       && location.hostname == this.hostname) {
        var target = $(this.hash);
        target = target.length ? target : $('[name=' + this.hash.slice(1) +']');
        if (target.length) {
          $('html,body').animate({ scrollTop: target.offset().top }, 500);
          return false;
        }
      }
    });
  });
}(jQuery));
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-8523256-1', 'auto');
  ga('send', 'pageview');

</script>


  </body>

</html>
