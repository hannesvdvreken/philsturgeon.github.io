<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <!-- (1) Optimize for mobile versions: http://goo.gl/EOpFl -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- (1) force latest IE rendering engine: bit.ly/1c8EiC9 -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Vagrant and Chef: Upgrade Party | Phil Sturgeon</title>
  <meta name="description" content="I used to contribute to the PHP-FIG, The League of Extraordinary Packages, PHP The Right Way, CodeIgniter, FuelPHP, PyroCMS and a bunch of other stuff, but I gave it all up to join the circus" />

  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link rel="stylesheet" href="//brick.a.ssl.fastly.net/Linux+Libertine:400,400i,700,700i/Open+Sans:400,400i,700,700i">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

  <link href="/stylesheets/main.css" rel="stylesheet" media="screen" />
  <link href="/stylesheets/print.css" rel="stylesheet" media="print" />
  <link href="/images/favicon.png" rel="icon" type="image/png" />

  <meta property="og:title" content="Vagrant and Chef: Upgrade Party" />
  <meta property="og:type" content="article" />
  <meta property="article:author" content="Phil Sturgeon" />
  <meta property="og:description" content="The other day I thought to myself, I really should be using a RVM gemset for my &quot;devops&quot; repo, which contains all my Vagrant and Chef logic (along with submodules for everything else). This broke everything, but I got there in the end." />
  <meta property="og:site_name" content="Phil Sturgeon" />
  <meta property="og:image" content="https://philsturgeon.uk/images/author.jpg" />
  <meta property="og:url" content="https://philsturgeon.uk/devops/2013/04/26/vagrant-and-chef-upgrade-party/" />
  <meta property="og:locale" content="en_GB" />
  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@philsturgeon">
  <meta name="twitter:title" content="Vagrant and Chef: Upgrade Party | Phil Sturgeon">
  <meta name="twitter:image:src" content="https://philsturgeon.uk/images/author.jpg">
  <meta name="twitter:url" content="https://philsturgeon.uk/devops/2013/04/26/vagrant-and-chef-upgrade-party/">
  <meta name="twitter:description" content="The other day I thought to myself, I really should be using a RVM gemset for my &quot;devops&quot; repo, which contains all my Vagrant and Chef logic (along with submodules for everything else). This broke everything, but I got there in the end.">
  <meta name="twitter:creator" content="@philsturgeon">
  
  <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
</head>


  <body>

    <a class='fa fa-home logo-readium' href='/'></a>


    <!-- content start -->

    <main class="content" role="main">
      <article class="post">
        <div class="noarticleimage">
          <div class="post-meta">
            <h1 class="post-title">Vagrant and Chef: Upgrade Party</h1>
            <div class="cf post-meta-text">
              <div class="author-image" style="background-image: url(/images/author.jpg)">Blog Logo</div>
              <h4 class="author-name" itemprop="author" itemscope itemtype="http://schema.org/Person">Phil Sturgeon</h4>
              on
              <time datetime="2013-04-26 22:00:00 UTC">
                Apr 26 2013
              </time>
            </div>
          </div>
        </div>
        <br>
        <br>
        <br>
        <section class="post-content">
          <div class="post-reading">
            <span class="post-reading-time"></span> read
          </div>
          <a name="topofpage"></a>
          <p>The other day I thought to myself, I really should be using a RVM gemset for my “devops” repo, which contains all my Vagrant and Chef logic (along with submodules for everything else).</p>

<p>This repo is meant to be a minimum-fuss “Go-bag” for any freelancers I bring in to help me at Kapture so using a Gemset for this reduces an extra step of “Oh yeah you need to make sure you have this version of Ruby and these gems installed”.</p>

<p>In doing this, I accidentally forced myself to upgrade from Chef 10.12 to v11.4 and Vagrant v1.2.2. These both had breaking changes, so this ended up sucking pretty badly.</p>

<p>This guide shows how I muddled through. There are other ways of doing it no doubt, and I may well be showing ignorance or stupidity in my approaches, but this is how I went from “everything working” to “its fucked” to “everything working again”.</p>

<h3 id="vagrant-upgrade">Vagrant Upgrade</h3>

<p>I deleted the gem locally and tried to install it in my gemset, but then noticed in the docs the newest version no longer has a gem.</p>

<p>I could have installed an old version, but they’ve been recommending against using the gem for a while so I jumped in the deep end with v1.2.2.</p>

<p>The upgrade was actually simple, I just made a metadata.json file next to Vagrantfile:</p>

<pre class="highlight javascript"><code><span class="p">{</span>
    <span class="s2">"provider"</span><span class="err">:</span> <span class="s2">"virtualbox"</span>
<span class="p">}</span>
</code></pre>

<p>After that I found myself having to destroy the box, and bring it back up. That’s fine because Chef has it provisioned and everything so, I did that, rebuilt it and carried on working all day.</p>

<h3 id="chef-troubles">Chef Troubles</h3>

<p>I had two problems with Chef this week. The first came from me not noticing the new Chef gem in my gemset was 11.4, and my Vagrant box was rocking it old school on v10.12. I’ve been using these systems without updating anything while I build out Kapture, but the guys building Chef have been hard at work too.</p>

<p>While provisioning Chef throws out this error:</p>

<blockquote>
  <p>NoMethodError: undefined method `unpack’ for chef</p>
</blockquote>

<p>A little Googling took me to <a href="http://stackoverflow.com/questions/11325479/how-to-control-the-version-of-chef-that-vagrant-uses-to-provision-vms">StackOverflow</a> (funny that) and the solution worked nicely:</p>

<pre class="highlight plaintext"><code>$ vagrant up --no-provision 
$ vagrant ssh
</code></pre>

<p>When inside the vagrant box:</p>

<pre class="highlight plaintext"><code>$ sudo dpkg --purge chef chef-full
$ wget -O - https://opscode.com/chef/install.sh | sudo bash
$ sudo apt-get update &amp;&amp; sudo aptitude safe-upgrade
$ sudo rm /var/cache/apt/archives/*.deb
</code></pre>

<p>That took care of my Chef complaints perfectly, and I got to update my boxes. Again, I carried on working all day, but then I tried to bring the box back up the day after:</p>

<blockquote>
  <p>Vagrant assumes that this means the command failed!</p>

  <p>mount -t vboxsf -o uid=<code>id -u vagrant</code>,gid=<code>id -g vagrant</code> /vagrant /vagrant<br />
The following SSH command responded with a non-zero exit status.<br />
Vagrant assumes that this means the command failed!</p>
</blockquote>

<p>It turns out the command I ran to update Chef wiped out the Virtual Box Guest Additions. A quick chat on the IRC pointed me to the <a href="http://docs-v1.vagrantup.com/v1/docs/troubleshooting.html">Troubleshooting section</a> (thanks <a href="https://twitter.com/boden_c">Chris Boden</a>) and the first answer took care of this almost perfectly.</p>

<pre class="highlight plaintext"><code>$ sudo /etc/init.d/vboxadd setup
</code></pre>

<p>I ran that and got errors, indicating I was missing <code>linux-headers-3.5.0-27-generic</code>. So first I had to install that with apt-get then run the command again.</p>

<p>Now I can reload my box consistently. Yaaaay!</p>

<p>Luckily I am developing solo at Kapture at the moment, because going through all of this on multiple boxes, or getting multiple developers to destroy their boxes would have sucked.</p>

<p>To avoid many of the problems I’m going to start building my own boxes with <a href="https://github.com/jedi4ever/veewee">VeeWee</a>. This lets me build my own .box files, so I wouldn’t need to use an .box with old Chef then upgrade, I would just build a new box and it would magically install the latest version.</p>

<p>I really should have been doing this before, but until now I’ve been getting by fine with grabbing shit off <a href="http://www.vagrantbox.es/">Vagrantbox.es</a> and going with it.</p>

<p>I’ll blog this up when I’m done.</p>

<p><strong>Update:</strong> <a href="/blog/2013/05/build-your-own-vagrant-boxes-with-veewee">Done</a>.</p>

        </section>
        <footer class="post-footer">
            <section class="share">
                  <a class="icon-twitter" href="https://twitter.com/share?text=Vagrant and Chef: Upgrade Party&amp;url=https://philsturgeon.uk/devops/2013/04/26/vagrant-and-chef-upgrade-party/"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=255');return false;">
                  <i class="fa fa-twitter"></i><span class="hidden">twitter</span>
                  </a>
                  <a class="icon-facebook" href="https://www.facebook.com/sharer.php?t=Vagrant and Chef: Upgrade Party&amp;u=https://philsturgeon.uk/devops/2013/04/26/vagrant-and-chef-upgrade-party/"
                    onclick="window.open(this.href, 'facebook-share', 'width=550,height=255');return false;">
                  <i class="fa fa-facebook"></i><span class="hidden">facebook</span>
                  </a>
            </section>
            <section class="post-next-previous">
                <p>
                    Previous:
                    <a class="button" href="/php/2013/04/22/kapture-is-hiring/">Kapture is hiring</a>
                </p>
                <p style="float:right">
                    Next: 
                    <a class="button" href="/php/2013/05/01/testing-contributing-composer-packages/">Testing and Contributing with Composer Packages</a>
                </p>
            </section>
        </footer>
        <div class="bottom-teaser cf">
          <div class="more isLeft">
            <h5 class="index-headline featured"><span>Written by</span></h5>
            <section class="author">
              <div class="author-image" style="background-image: url(/images/author.jpg)">Blog Logo</div>
              <h4>Phil Sturgeon</h4>
              <p class="bio">I spend a lot of time urging people to learn more languages, and if that is a bit much learn another framework. Rails and Laravel are the same, and Go is a barrel of laughs.</p>
              <p>Get out of your rut.</p>
            </section>
          </div>
          <div class="more isRight">
            <h5 class="index-headline featured"><span>More Writing</span></h5>
            <section class="author">
              <a href="http://apisyouwonthate.com/">
                <div class="book-image build-apis">Book Cover</div>
                <h4>Build APIs You Won't Hate</h4>
              </a>
              <p class="bio">Everyone and their dog wants an API, so you should probably learn how to build them.</p>
              <p><a href="http://apisyouwonthate.com/">Buy it from LeanPub or Amazon</a>.</p>
            </section>
          </div>
        </div>
      </article>

      <div id="disqus_thread"></div>
      <script type="text/javascript">
          /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
          var disqus_shortname = 'philsturgeon';

          var disqus_identifier = 'vagrant-and-chef-upgrade-party';

          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
              var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
              dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

    </main>
    <div class="bottom-closer">
      <div class="background-closer-image" style="background-image: url(/images/ciderphpants.jpg)">
        Image
      </div>
      <div class="inner">
        <h1 class="blog-title">Phil Sturgeon</h1>
        <h2 class="blog-description">I used to contribute to the PHP-FIG, The League of Extraordinary Packages, PHP The Right Way, CodeIgniter, FuelPHP, PyroCMS and a bunch of other stuff, but I gave it all up to join the circus</h2>
        <a href="/" class="btn">Back to Overview</a>
      </div>
    </div>

    <!-- content end -->

    <footer class='footer' role='contentinfo'>
  <div class='footer-links'>
    <ul class='context'>
      <li>
        <h3>Content</h3>
      </li>
      <li>
        <a href='/about'>About</a>
      </li>
      <li>
        <a href='/books'>Books</a>
      </li>
    </ul>
    <ul class='follow'>
      <li>
        <h3>Follow Me</h3>
      </li>
      <li>
        <a href='https://twitter.com/philsturgeon'>Twitter</a>
      </li>
      <li>
        <a href='https://github.com/'>GitHub</a>
      </li>
      <li>
        <a href='http://phptownhall.com/'>PHP Town Hall</a>
      </li>
    </ul>
    <ul class='recent_posts'>
      <li>
        <h3>Recent Posts</h3>
        <ul>
          <li><a href="/http/2015/09/03/auto-incrementing-to-destruction/">Auto-Incrementing IDs: Giving your Data Away</a></li>
          <li><a href="/charity/2015/08/22/no-booze/">No Booze for a Month</a></li>
          <li><a href="/feminism/2015/08/17/women-speaker-ratio-conversation-loop/">The Ratio of Women Speakers in Tech</a></li>
        </ul>
      </li>
    </ul>
  </div>
</footer>

    <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
<script src="/javascripts/jquery.fitvids.js"></script>
<script src="/javascripts/index.js"></script>
<script src="/javascripts/readingTime.min.js"></script>
<script>
(function ($) {
  "use strict";
  $(document).ready(function(){

    var $window = $(window),
    $image = $('.post-image-image, .teaserimage-image');
    $window.on('scroll', function() {
      var top = $window.scrollTop();

      if (top < 0 || top > 1500) { return; }
      $image
        .css('transform', 'translate3d(0px, '+top/3+'px, 0px)')
        .css('opacity', 1-Math.max(top/700, 0));
    });
    $window.trigger('scroll');

    var height = $('.article-image').height();
    $('.post-content').css('padding-top', height + 'px');

    $('a[href*=#]:not([href=#])').click(function() {
      if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'')
       && location.hostname == this.hostname) {
        var target = $(this.hash);
        target = target.length ? target : $('[name=' + this.hash.slice(1) +']');
        if (target.length) {
          $('html,body').animate({ scrollTop: target.offset().top }, 500);
          return false;
        }
      }
    });
  });
}(jQuery));
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-8523256-1', 'auto');
  ga('send', 'pageview');

</script>


  </body>

</html>
